# 货币

## 一、基础信息简介

### 货币三要素

- **货币币种**：使用的货币类型，如“CNY”（人民币）、“USD”（美元）
- **货币金额** ：在某币种下，表示货币数量用到的货币数字，如“CNY 100”中的“100”
- **货币单位**：比如使用人民币，单位使用元还是分
    - 基准单位：最常用的单位，一般是当地的元
    - 最小单位：一般是当地的分，但有些国家可能没有分（比如日元）

### 货币问题分类

- 货币信息：
    - 币种：一个地区使用的货币币种是什么？用美元还是人民币
    - 精度：美元金额要保留2位小数还是取整？
    - 汇率：美元转人民币的汇率是多少？
- 货币展示：
    - 货币符号：美元的货币符号是“US”还是“$”? 人民币的货币符号是“￥”还是“元”？
    - 数字表示：“$1.000” 表示1000美元还是1美元？
    - 符号位置：到底应该是“$ 1.00” 还是 “1.00 $”？
    

## 二、国际标准

### 1. **ISO 4217 三字母货币码**

ISO4217 定义了三个字母的货币代码，例如 USD 表示美元。此标准还定义了每个货币的小数点位置和格式等信息。

[ISO 4217的官方链接](https://www.iso.org/iso-4217-currency-codes.html)
[维基百科链接](https://zh.wikipedia.org/zh-hans/ISO_4217)

### 2. ISO 10916 货币金额表示法

这是一份国际标准，规定了货币金额表示法的基本原则，包括货币符号、金额表示方式、货币小数点分隔符等。

 [ISO 10916的官方链接](https://www.iso.org/standard/57248.html)

## 三、最佳实践

货币处理5阶段

### 1.货币生成

（1）用户录入货币信息时，货币单位一般使用基准单位（元），金额保留2位小数（如有小数）。

（2）服务直接生成货币信息时，抹零取整需在数据生产源头完成。

- 解释：货币金额在展现和存储上要一致（价值上等价），数据及派生数据的源头做统一的精度、取整、抹零处理后，再存储、展现或传递到下游，以保证数据的全局一致性。
如“取消费”由服务管控产生，必须由服务管控做取整抹零处理，其他使用方直接使用即可。
    
    

### 2. 货币传输

货币传输 需明确币种、金额、单位三要素。一般单位使用最小单位，金额使用64位有符号整数。

- 解释：使用最小单位，可以让金额保证是整数。
    
    32位整数可能整数溢出，浮点数可能有精度损失。
    

### 3. 货币计算

（1）货币计算 需明确币种、金额、单位三要素。单位一般使用最小单位，金额使用64位有符号整数。

（2）分账时若使用除法，注意可能无法整除，此时需使用减法确保账平。

（3）限额不要写死，要做配置化，大小根据汇率来调配

- 解释：比如最大优惠券额度不能超过100元。如果代码中写死，由于有些币种非常不值钱，会导致所有优惠券都不可用。因此：
    
    a. 限额要做成可配置的，具体限额值应将可接受的人民币金额按汇率折算成当地货币金额
    b. 限额可用来防止极端输入下的大额资损及计算溢出
    

（4）货币金额变量名建议使用分段命名

- 解释：货币数据在变量命名时，必须采用分段命名方式提高可读性。
包含核心含义（该名字的用途等）、数值类型（string、int64等）、货币单位（fen、yuan）等，
如“display_amount_string_yuan”，"total_fee_int64_fen"
    
    

### 4. 货币存储

（1）货币存储 需明确币种、金额、单位三要素。币种可用国家或地区或币种来表示，单位一般使用最小单位，金额使用64位有符号整数。

- 解释： 币种保存 国家码也可，是因为 由国家码可以推出货币币种
    
    

### 5. 货币展示

（1）货币文案建议由后端服务下发

- 解释：服务端生成文案更收敛（服务端一份数据会在多个终端展现）和更可控（如能快速升级止损）
    
    

（2）货币展示由统一SDK进行格式化，确保扩展性、正确性、一致性。比如可使用ICU。

- 解释：不同国家货币符号、数字样式等都不相同，每个业务如果都自己实现，每开个国家所有业务都需开发，成本高且不收敛。
    
    

## 四、工具集合

### 1. 汇率工具

| 站点链接 | 特性 |
| --- | --- |
| https://fixer.io/documentation | 小时更新, eur基准 |
| https://currencylayer.com/documentation | 每日更新、usd基准 |
| https://docs.openexchangerates.org/reference/api-introduction | 小时更新、usd为基准 |

## 五、知名开源项目

### ICU

介绍

- [ICU](https://unicode-org.github.io/icu/) international components for unicode，国际化unicode组件库。ICU是一个开源的C/C++、java类库，提供unicode和全球化支持。它是跨平台的，在所有平台都可以给出相同的结果。

[icu文档](https://unicode-org.github.io/icu/)

[icu的github](https://github.com/unicode-org/icu)

[icu的数据](https://github.com/unicode-org/icu-data)

### icu4x

- [icu4x](https://github.com/unicode-org/icu4x) - CU4X提供了支持广泛软件国际化的组件。它深刻借鉴了ICU4C、ICU4J和ECMA-402的经验，并依赖于CLDR项目的数据。

### [golang.org/x/text](http://golang.org/x/text)

github地址： https://github.com/golang/text/

golang.org/x/text是Go语言的一个子项目，它提供了文本处理的相关功能。它包含了很多有用的子包，可以用于本地化、字符集转换、文本处理与格式化、数字格式化、货币处理等。